
%% bare_conf.tex
%% V1.4b
%% 2015/08/26
%% by Michael Shell
%% See:
%% http://www.michaelshell.org/
%% for current contact information.
%%
%% This is a skeleton file demonstrating the use of IEEEtran.cls
%% (requires IEEEtran.cls version 1.8b or later) with an IEEE
%% conference paper.
%%
%% Support sites:
%% http://www.michaelshell.org/tex/ieeetran/
%% http://www.ctan.org/pkg/ieeetran
%% and
%% http://www.ieee.org/

%%*************************************************************************
%% Legal Notice:
%% This code is offered as-is without any warranty either expressed or
%% implied; without even the implied warranty of MERCHANTABILITY or
%% FITNESS FOR A PARTICULAR PURPOSE! 
%% User assumes all risk.
%% In no event shall the IEEE or any contributor to this code be liable for
%% any damages or losses, including, but not limited to, incidental,
%% consequential, or any other damages, resulting from the use or misuse
%% of any information contained here.
%%
%% All comments are the opinions of their respective authors and are not
%% necessarily endorsed by the IEEE.
%%
%% This work is distributed under the LaTeX Project Public License (LPPL)
%% ( http://www.latex-project.org/ ) version 1.3, and may be freely used,
%% distributed and modified. A copy of the LPPL, version 1.3, is included
%% in the base LaTeX documentation of all distributions of LaTeX released
%% 2003/12/01 or later.
%% Retain all contribution notices and credits.
%% ** Modified files should be clearly indicated as such, including  **
%% ** renaming them and changing author support contact information. **
%%*************************************************************************


% *** Authors should verify (and, if needed, correct) their LaTeX system  ***
% *** with the testflow diagnostic prior to trusting their LaTeX platform ***
% *** with production work. The IEEE's font choices and paper sizes can   ***
% *** trigger bugs that do not appear when using other class files.       ***                          ***
% The testflow support page is at:
% http://www.michaelshell.org/tex/testflow/



\documentclass[conference]{IEEEtran}
\usepackage{listings}
% Some Computer Society conferences also require the compsoc mode option,
% but others use the standard conference format.
%
% If IEEEtran.cls has not been installed into the LaTeX system files,
% manually specify the path to it like:
% \documentclass[conference]{../sty/IEEEtran}





% Some very useful LaTeX packages include:
% (uncomment the ones you want to load)


% *** MISC UTILITY PACKAGES ***
%
%\usepackage{ifpdf}
% Heiko Oberdiek's ifpdf.sty is very useful if you need conditional
% compilation based on whether the output is pdf or dvi.
% usage:
% \ifpdf
%   % pdf code
% \else
%   % dvi code
% \fi
% The latest version of ifpdf.sty can be obtained from:
% http://www.ctan.org/pkg/ifpdf
% Also, note that IEEEtran.cls V1.7 and later provides a builtin
% \ifCLASSINFOpdf conditional that works the same way.
% When switching from latex to pdflatex and vice-versa, the compiler may
% have to be run twice to clear warning/error messages.






% *** CITATION PACKAGES ***
%
%\usepackage{cite}
% cite.sty was written by Donald Arseneau
% V1.6 and later of IEEEtran pre-defines the format of the cite.sty package
% \cite{} output to follow that of the IEEE. Loading the cite package will
% result in citation numbers being automatically sorted and properly
% "compressed/ranged". e.g., [1], [9], [2], [7], [5], [6] without using
% cite.sty will become [1], [2], [5]--[7], [9] using cite.sty. cite.sty's
% \cite will automatically add leading space, if needed. Use cite.sty's
% noadjust option (cite.sty V3.8 and later) if you want to turn this off
% such as if a citation ever needs to be enclosed in parenthesis.
% cite.sty is already installed on most LaTeX systems. Be sure and use
% version 5.0 (2009-03-20) and later if using hyperref.sty.
% The latest version can be obtained at:
% http://www.ctan.org/pkg/cite
% The documentation is contained in the cite.sty file itself.






% *** GRAPHICS RELATED PACKAGES ***
%
\ifCLASSINFOpdf
\usepackage[pdftex]{graphicx}
  % declare the path(s) where your graphic files are
\graphicspath{{./img/}}
  % and their extensions so you won't have to specify these with
  % every instance of \includegraphics
\DeclareGraphicsExtensions{.pdf,.jpeg,.png}
\else
  % or other class option (dvipsone, dvipdf, if not using dvips). graphicx
  % will default to the driver specified in the system graphics.cfg if no
  % driver is specified.
  % \usepackage[dvips]{graphicx}
  % declare the path(s) where your graphic files are
  % \graphicspath{{../eps/}}
  % and their extensions so you won't have to specify these with
  % every instance of \includegraphics
  % \DeclareGraphicsExtensions{.eps}
\fi
% graphicx was written by David Carlisle and Sebastian Rahtz. It is
% required if you want graphics, photos, etc. graphicx.sty is already
% installed on most LaTeX systems. The latest version and documentation
% can be obtained at: 
% http://www.ctan.org/pkg/graphicx
% Another good source of documentation is "Using Imported Graphics in
% LaTeX2e" by Keith Reckdahl which can be found at:
% http://www.ctan.org/pkg/epslatex
%
% latex, and pdflatex in dvi mode, support graphics in encapsulated
% postscript (.eps) format. pdflatex in pdf mode supports graphics
% in .pdf, .jpeg, .png and .mps (metapost) formats. Users should ensure
% that all non-photo figures use a vector format (.eps, .pdf, .mps) and
% not a bitmapped formats (.jpeg, .png). The IEEE frowns on bitmapped formats
% which can result in "jaggedy"/blurry rendering of lines and letters as
% well as large increases in file sizes.
%
% You can find documentation about the pdfTeX application at:
% http://www.tug.org/applications/pdftex





% *** MATH PACKAGES ***
%
% \usepackage{amsthm}
% \usepackage{amsmath}
% A popular package from the American Mathematical Society that provides
% many useful and powerful commands for dealing with mathematics.
%
% Note that the amsmath package sets \interdisplaylinepenalty to 10000
% thus preventing page breaks from occurring within multiline equations. Use:
%\interdisplaylinepenalty=2500
% after loading amsmath to restore such page breaks as IEEEtran.cls normally
% does. amsmath.sty is already installed on most LaTeX systems. The latest
% version and documentation can be obtained at:
% http://www.ctan.org/pkg/amsmath





% *** SPECIALIZED LIST PACKAGES ***
%
%\usepackage{algorithmic}
% algorithmic.sty was written by Peter Williams and Rogerio Brito.
% This package provides an algorithmic environment fo describing algorithms.
% You can use the algorithmic environment in-text or within a figure
% environment to provide for a floating algorithm. Do NOT use the algorithm
% floating environment provided by algorithm.sty (by the same authors) or
% algorithm2e.sty (by Christophe Fiorio) as the IEEE does not use dedicated
% algorithm float types and packages that provide these will not provide
% correct IEEE style captions. The latest version and documentation of
% algorithmic.sty can be obtained at:
% http://www.ctan.org/pkg/algorithms
% Also of interest may be the (relatively newer and more customizable)
% algorithmicx.sty package by Szasz Janos:
% http://www.ctan.org/pkg/algorithmicx

\usepackage{amsthm, amsmath,amssymb,amsbsy,amsfonts,amstext,rotating}
\usepackage{alltt,multicol,pifont}
\usepackage{booktabs,multirow,subfigure,epsfig}
\usepackage{xspace}
\newcommand{\eplopmark}{\ding{73}}

% *** ALIGNMENT PACKAGES ***
%
\usepackage{array,tabularx}
% Frank Mittelbach's and David Carlisle's array.sty patches and improves
% the standard LaTeX2e array and tabular environments to provide better
% appearance and additional user controls. As the default LaTeX2e table
% generation code is lacking to the point of almost being broken with
% respect to the quality of the end results, all users are strongly
% advised to use an enhanced (at the very least that provided by array.sty)
% set of table tools. array.sty is already installed on most systems. The
% latest version and documentation can be obtained at:
% http://www.ctan.org/pkg/array


% IEEEtran contains the IEEEeqnarray family of commands that can be used to
% generate multiline equations as well as matrices, tables, etc., of high
% quality.




% *** SUBFIGURE PACKAGES ***
%\ifCLASSOPTIONcompsoc
%  \usepackage[caption=false,font=normalsize,labelfont=sf,textfont=sf]{subfig}
%\else
%  \usepackage[caption=false,font=footnotesize]{subfig}
%\fi
% subfig.sty, written by Steven Douglas Cochran, is the modern replacement
% for subfigure.sty, the latter of which is no longer maintained and is
% incompatible with some LaTeX packages including fixltx2e. However,
% subfig.sty requires and automatically loads Axel Sommerfeldt's caption.sty
% which will override IEEEtran.cls' handling of captions and this will result
% in non-IEEE style figure/table captions. To prevent this problem, be sure
% and invoke subfig.sty's "caption=false" package option (available since
% subfig.sty version 1.3, 2005/06/28) as this is will preserve IEEEtran.cls
% handling of captions.
% Note that the Computer Society format requires a larger sans serif font
% than the serif footnote size font used in traditional IEEE formatting
% and thus the need to invoke different subfig.sty package options depending
% on whether compsoc mode has been enabled.
%
% The latest version and documentation of subfig.sty can be obtained at:
% http://www.ctan.org/pkg/subfig




% *** FLOAT PACKAGES ***
%
%\usepackage{fixltx2e}
% fixltx2e, the successor to the earlier fix2col.sty, was written by
% Frank Mittelbach and David Carlisle. This package corrects a few problems
% in the LaTeX2e kernel, the most notable of which is that in current
% LaTeX2e releases, the ordering of single and double column floats is not
% guaranteed to be preserved. Thus, an unpatched LaTeX2e can allow a
% single column figure to be placed prior to an earlier double column
% figure.
% Be aware that LaTeX2e kernels dated 2015 and later have fixltx2e.sty's
% corrections already built into the system in which case a warning will
% be issued if an attempt is made to load fixltx2e.sty as it is no longer
% needed.
% The latest version and documentation can be found at:
% http://www.ctan.org/pkg/fixltx2e


%\usepackage{stfloats}
% stfloats.sty was written by Sigitas Tolusis. This package gives LaTeX2e
% the ability to do double column floats at the bottom of the page as well
% as the top. (e.g., "\begin{figure*}[!b]" is not normally possible in
% LaTeX2e). It also provides a command:
%\fnbelowfloat
% to enable the placement of footnotes below bottom floats (the standard
% LaTeX2e kernel puts them above bottom floats). This is an invasive package
% which rewrites many portions of the LaTeX2e float routines. It may not work
% with other packages that modify the LaTeX2e float routines. The latest
% version and documentation can be obtained at:
% http://www.ctan.org/pkg/stfloats
% Do not use the stfloats baselinefloat ability as the IEEE does not allow
% \baselineskip to stretch. Authors submitting work to the IEEE should note
% that the IEEE rarely uses double column equations and that authors should try
% to avoid such use. Do not be tempted to use the cuted.sty or midfloat.sty
% packages (also by Sigitas Tolusis) as the IEEE does not format its papers in
% such ways.
% Do not attempt to use stfloats with fixltx2e as they are incompatible.
% Instead, use Morten Hogholm'a dblfloatfix which combines the features
% of both fixltx2e and stfloats:
%
% \usepackage{dblfloatfix}
% The latest version can be found at:
% http://www.ctan.org/pkg/dblfloatfix




% *** PDF, URL AND HYPERLINK PACKAGES ***
%
\usepackage{url}
% url.sty was written by Donald Arseneau. It provides better support for
% handling and breaking URLs. url.sty is already installed on most LaTeX
% systems. The latest version and documentation can be obtained at:
% http://www.ctan.org/pkg/url
% Basically, \url{my_url_here}.




% *** Do not adjust lengths that control margins, column widths, etc. ***
% *** Do not use packages that alter fonts (such as pslatex).         ***
% There should be no need to do such things with IEEEtran.cls V1.6 and later.
% (Unless specifically asked to do so by the journal or conference you plan
% to submit to, of course. )

\usepackage[utf8]{inputenc}
\usepackage[english]{babel}

\theoremstyle{definition}
\newtheorem{definition}{Definition}

% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}

\usepackage{tipa}
\usepackage{array,tabularx}
\usepackage{color}
\definecolor{applegreen}{rgb}{0.55, 0.71, 0.0}
\definecolor{bananayellow}{rgb}{1.0, 0.88, 0.21}
\definecolor{blue}{rgb}{0.0, 0.53, 0.74}

\begin{document}
%
% paper title
% Titles are generally capitalized except for words such as a, an, and, as,
% at, but, by, for, in, nor, of, on, or, the, to and up, which are usually
% not capitalized unless they are the first or last word of the title.
% Linebreaks \\ can be used within to get better formatting as desired.
% Do not put math or special symbols in the title.
\title{Test event generation for a fall-detection IoT system}


% author names and affiliations
% use a multiple column layout for up to three different
% affiliations
\author{\IEEEauthorblockN{Lorena Guti\'errez-Madro\~nal, Inmaculada Medina-Bulo}
\IEEEauthorblockA{UCASE Research Group\\
University of Cadiz, Spain\\
Email: \{lorena.gutierrez, inmaculada.medina\}@uca.es}
\and
\IEEEauthorblockN{Luigi La Blunda, Matthias F. Wagner}
\IEEEauthorblockA{WSN and IOT Research Group\\
Frankfurt University of Applied Sciences\\
Email: \{l.lablunda,mfwagner\}@fb2.fra-uas.de}}

\maketitle

\begin{abstract}
The Internet of Things (IoT) is a very popular paradigm which has been applied to different areas 
such as smart cities, medicine, business process, etc. The IoT system's main inconvenience is to make
decisions in real time according to a huge amount of information that arrives as events. This information
is filtered thanks to the Event Processing Languages (EPL), which use patterns to define the relevant situations.
So, given that filter the correct information is crucial to carry out the established actions, testing these
IoT systems is imperative.
In the majority of the relevant situations to detect, the events have a specific behaviour which must
be simulated to test the IoT system. Moreover, in several situations it is quite difficult to obtain test events with
specific values: adverse environment conditions, rise or fall in blood pressure, heart attack, falls... 
In this paper we introduce a fall analysis and the test event generation using IoT-TEG tool. The fall analysis
has highlighted the special behaviour of the fall-involved events and the necessity to improve the IoT-TEG with
a new functionality which allows to define the desired behaviour by defining behaviour rules.
\end{abstract}

\IEEEpeerreviewmaketitle

\section{Introduction}

Due to the progress of health care, the longevity of people increases and this leads to an ageing society. Elderly people are exposed 
to a higher risk of falling because of the growing age and multiple diseases, which cause serious injuries that require long convalescence 
and restriction of mobility. According to the survey of the \textit{Robert Koch Institute}~\cite{Varnaccia2013}, 53.7\% of accidents in the age 
group over 60 are caused by falls. Statistically, about one-third of the elderly people suffer severe lesions and the half of them suffer 
fall-events repeatedly~\cite{Schott2008}. Falls are not caused by a single cause, 90\% of them occurred from multiple factors. These 
factors refer to old-age or illness (intrinsic factors) or external factors e.g. hazards which occur at home, in traffic or during activities 
of daily life (extrinsic factors)~\cite{Schott2008}. The founder of \textit{Vigilio Telemedical} reported that yearly more than 20 million 
elderly over the age of 65 in Europe experience fall-situations, that lead to traumatic based cases of death~\cite{Vigilio,APAOTS2013}. 
Additionally, people affected by Dementia and Parkinson have a higher risk to fall. In accordance with~\cite{Monks} research proved that 
Dementia-patients have a 20 times higher risk and Parkinson-patients a 10 times higher risk of falling than healthy people of the same age. 
To counteract these life-threatening situations a fast and fully automated assistance is needed, because an unconscious person may not be 
able to call the emergency services. An approach could be continuous monitoring of medical and/or physical signals via a wearable sensor 
network (see Figure~\ref{fig:simulation}). 

\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.2]{img/Figure1}
  \caption[Escalation scheme]{Scheme fall simulation~\cite{LaBlunda.2016,LaBlunda.2016b,LaBlunda.2016c}}
  \label{fig:simulation}
\end{figure}

A prototype in form of a belt was developed, which is worn on the hip by the patient and consists 
of a five sensor nodes Body Area Network (BAN)~\cite{LaBlunda.2016,LaBlunda.2016b}. 
The obtained data are used to define an EPL of EsperTech~\cite{Esper:2016} pattern to detect falls. 
The Event processing languages (EPL) have been designed to address the main problems of IoT systems. 
Among the existing EPLs, the EPL of EsperTech is used the most often. EPLs are used to define event 
patterns and event rules. In particular, EPLs are used to define critical situations
in order to filter the information and to make correct decisions according to the obtained data.

The first step of this prototype is to identify a fall from a fast movement, a sitting move or laying 
down move, but the final goal of the to be finished system is to predict the falls and act to prevent 
them. Given that to test this system is crucial, test events which simulate falls are necessary. In 
the literature can be found different type of falls, and it is necessary to identify all of them in 
order to tell them apart from a no-fall; in this study two types of falls will be analysed. 

IoT-TEG~\cite{TesisGutierrez2017,Gutierrez2017} is a tool which automatically generates test events 
of many types. Thanks to the obtained data from the sensors we have checked that the measured 
parameter during a fall, the acceleration, has a specific behaviour. As a consequence, the test events 
must be generated according to its behaviour. This problem is solved with the new functionality that 
IoT-TEG includes which is introduced in this paper. Moreover, the ongoing fall detection prototype will 
be analysed and its improvements will be described; the new functionality of IoT-TEG can be adapted 
according to the improvements of the fall detection prototype. The main contributions of this paper are:

\begin{itemize}
 \item \textbf{A new functionality of the IoT-TEG system} which allows to simulate the behaviour of 
 different event attributes in order to generate test events following a specific pattern.
 \item \textbf{An analysis of the major parameter in a fall}; while a person is falling, the acceleration 
 is the parameter that can measure the movement of the body. This parameter is analysed in order to know 
 its behaviour during two types of falls.
 \item \textbf{A study of the fall detection prototype evolution}; the system which is been used is
 continuously being improved. We describe the evolution of its architecture, how the data is analysed and 
 the detected problems.
 \item \textbf{New definitions of two types of falls}; after the analysis of the acceleration during two 
 types of falls a new definition for each one has been done. The obtained data of the fall detection 
 prototype is used to define an EPL of EsperTech pattern to detect those type of falls. 
\end{itemize}

The rest of this paper is organised as follows. Section~\ref{sec:relatedwork}
describes not only the related work of event generators, but also the existing
solutions for fall-detection. Section~\ref{sec:background} provides the basic
knowledge of falls, Event Processing Languages and IoT-TEG tool. The architecture
of the fall detection system and the fall analysis are 
introduced in Section~\ref{sec:basicprototype}. Section~\ref{sec:improvedprototype}
describes the improvements on the prototype, a new fall type analysis,
a comparison of the obtained results and some detected problems. Finally, in Section~\ref{sec:conclusions}, 
we conclude our paper and make recommendations for future work.

\section{Related work}
\label{sec:relatedwork}

An overview about event generators reveals that the first event generators~\cite{dobbs2004houches,mangano2005tools}
were focused on extremely specific topics such as environmental conditions for the simulation of high energy 
physics events at particle colliders. Nowadays, we can find papers that address the same issues~\cite{Grzegorczyk}, but 
the technology surrounds us and the people and business need to control and monitor the things around them. 
The received information allows them to make decisions and to act according to it. This is the reason 
of the creation of the IoT Platforms, which are the key for the development of scalable IoT applications and 
services that connect objects, systems and people to each other. However, not every IoT Platform is an IoT 
Platform~\cite{iot-analytics:2015}; for instance, some event generators that are integrated in an enterprise 
software packages, which are increasingly allowing the integration of IoT devices, are often not advanced enough
to be classified as a full IoT Platform. Examples are given in the following lines:

The Timing System~\cite{Finland:2016} provides a complete timing distribution system including timing signal generation. Its event
generator is responsible for creating timing events which are sent out as serialised event frames.

The company Starcom~\cite{Starcom:2016} has developed an event generator to solve the problem of managing a huge number of
events. They state that their generator is capable of controlling the end event action, so the exact managers requirements can
be filtered. The tool is included in a kit distributed with their system.

The WebLogic Integration Solutions~\cite{WebLogic:2016} allows the managing and monitoring of entities and resources 
required for WebLogic Integration applications. This system contains an event generator module which allows the 
creation and deployment of the event generators included as part of WebLogic Integration. The mentioned events 
generators allow to define event types but they are not capable to simulate a specific behaviour with a set of 
generated events. The relevant situations in IoT systems are a sequence of activities with a determined behaviour; 
that is why IoT-TEG~\cite{TesisGutierrez2017,Gutierrez2017} includes this option.

Talking about fall-detection, there are several solutions that propose wearable sensors. A commercial solution which is 
available on the market is the VigiFall system~\cite{Vigilio,EuropeanCommission2013}, supported by the European Commission. This system 
includes a wearable self-adhesive accelerometer, several motion sensors which are fixed in the living area and a calling unit to provide 
a fully automated emergency call. The self-adhesive patch communicates with the infrared motion detectors and in the case of a fall the 
wearable patch sends a signal out. Thereby the infrared sensors placed in the room are capable to recognise that there are no movements anymore and 
contacts the central unit. When the central node receives this flag, the emergency call is executed. The weak point of VigiFall~\cite{Vigilio} is 
the system structure which depends on the sensor-based room infrastructure. Once the patient leaves this area the system is not capable 
to provide the functionalities in case of a fall-event. Igual et al.~\cite{Igual2013} examined different fall-detection approaches which they 
categorised into context-aware systems and wearable systems. Context-aware systems depend on the living area of the patient, where 
sensors and actuators placed in the environment interact with the wearable node of the person to detect falls. Another solution based 
on this principle is a video-based method, which facilitates a reliable detection of falls but the patients would be exposed to a 
loss of privacy and this is not well accepted. Additionally the high purchase price is a barrier for many people and the dependency 
on the environment makes these system useless. The other system-type analysed by Igual et al.~\cite{Igual2013} comprises wearable systems, which 
are worn on the body and based on a BAN. This solution is able to detect falls independent from the environment in contrast to 
context-aware systems. They depict wearable systems which use the sensor fusion principle of accelerometer and gyroscope 
and built-in solutions that represent the usage of integrated smartphone sensors.

Taking into consideration wearable fall-detection solutions the approach proposed by Li et al.~\cite{Li2009} will be explained subsequently, 
which was used for the development of our prototype. They introduce a fall-detection method based on a BAN that consists 
of two wearable sensor nodes. These two nodes comprise an accelerometer and gyroscope and are worn on the chest, node A, and thigh 
node B, (see Figure~\ref{fig:simulation}). The principle of this method differentiates between static postures and dynamic postures: 

\begin{itemize}
 \item Static postures: standing, sitting, laying and bending.
 \item Dynamic postures
 \begin{itemize}
  \item Activities of daily life: walking, walk on stairs, sit, jump, lay down and run.
  \item Fall-like motions: quick sit down upright and quick sit-down reclined.
  \item Flat surface falls: fall forward, fall backward, fall right and fall left.
  \item Inclined falls: fall on stairs.
 \end{itemize}
\end{itemize}

\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.2]{img/BasePrototype.png}
  \caption[System architecture]{System architecture according to Li et al.~\cite{Li2009}}
  \label{fig:simulation}
\end{figure}

To decrease the computational effort of the micro-controller a three-phase algorithm was proposed, which is structured 
as follows:

\begin{enumerate}
 \item Phase activity analysis: check if person is in a static or dynamic position.
 \item Phase position analysis: if existing posture coincides with static posture, check whether the actual position corresponds to laying.
 \item Phase state transition analysis: if laying position, examine whether this transition was intentional or unintentional. The previous 5 
 seconds are used to analyse it. In the case that this position was unintentional, the system classifies it as a fall. 
\end{enumerate}

The weak point of this method is the differentiation between jumping into bed and falling against a wall with seated posture.

\section{Background}
\label{sec:background}

\subsection{Falls analysis}
\label{subsec:analysis}

The approach used to detect falls is based on the basic idea proposed by~\cite{Gjoreski2014,Kozina}. A typical acceleration pattern during 
a fall-event is a decreasing acceleration close to 0g (free fall), followed by an increasing acceleration value (see Figure~\ref{fig:grafica}). In a stationary position, 
the acceleration measured is around 1g (9.81$m/s^{2}$) and during falling around 0g (0$m/s^{2}$). Upon the impact to the ground (fall-event), 
the maximum acceleration (peak-value) is reached for a short time period and it is greater than 1g. This pattern can be used to 
detect fall-events using the integrated accelerometer of the sensor nodes (S1-S4). Important to know is that the acceleration 
magnitude which is illustrated in the Formula~\ref{eq:acel} was used for the fall-detection:

\begin{equation}\label{eq:acel}
 \alpha = \sqrt{\alpha_{x}^{2} + \alpha_{y}^{2} + \alpha_{z}^{2}}
\end{equation}
% \overrightarrow{\left | \alpha \right |} = \sqrt{\alpha_{x}^{2} + \alpha_{y}^{2} + \alpha_{z}^{2}}
\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.75]{img/FallGraph}
  \caption[Acceleration during impact]{Acceleration during impact~\cite{Kozina}.}
  \label{fig:grafica}
\end{figure}

Taking into consideration the depicted Figure~\ref{fig:grafica}, we can apply the following rule to evaluate the incoming acceleration data:

\begin{equation}\label{eq:caida}
 \alpha_{max} - \alpha_{min} > 1g
\end{equation}

in 1 second window and $\alpha_{max}$ came after $\alpha_{min}$; where $\alpha_{max}$ is the maximum acceleration value, 
$\alpha_{min}$ is the minimum acceleration value and $1g\approx9.81m/s^{2}$. Looking at the rule an event is categorised as a fall when the 
difference between $\alpha_{max}$ and $\alpha_{min}$ is greater than 1g and $\alpha_{min}$ is followed by $\alpha_{max}$. 
Important is that this should happen within a time window of 1 second due to the fact, that a fall can occur in less than 1 second~\cite{Luder2009}.
To apply this rule we used the Event Processing Language (EPL) of EsperTech~\cite{Esper:2016} to integrate it in a IoT system which detect falls.

\subsection{Fall patterns with EPL of EsperTech}

Etzion and Niblett~\cite{Etz10} defined \textit{event processing agents} as software modules that process events. Such agents are specified using an 
event processing language, and there are a number of styles of event processing languages in use. The following styles are included:

\begin{itemize}
 \item Rule-oriented languages
 \begin{itemize}
 \item Production rules: Production rules are rules of the type \textit{if condition then action}: when the condition is satisfied, the action is performed.
 \item Active rules: Active rules are rules of the type \textit{event-condition-action}: when an event occurs, the conditions are evaluated and, if they are satisfied, 
 it triggers an action.
 \item Logic rules: A programming style based on logical assertions and a deductive database. 
 \end{itemize}
 \item Imperative programming languages: The imperative programming languages define the operators which will be applied to the events. Each operator is a
 transformation in the event.
 \item Stream-oriented languages: The languages used to describe the queries are inspired by SQL and relational algebra, though not all of them are 
 based on SQL.
\end{itemize}

The EPL in which our work is based on is EPL of Esper~\cite{Esper:2016}, an EPL stream-oriented language. The main reasons of its selection are: 
it is an extension of SQL, it can be embedded into Java applications and it is open source. On the other hand, it is executed by Esper, a
CEP engine which can process around 500.000 events per second on a workstation, and between 70.000 and 200.000 events per second on a laptop (according to 
the company EsperTech).
 
As it was mentioned before, the EPL of EsperTech is a SQL like query language. However, unlike SQL that operates on tables, EPL operates on continuous stream of events. As a 
result, a row from a table in SQL is analogous to an event present in an event stream. An EPL statement starts executing continuously during 
runtime. While the execution is taking place, EPL queries will be triggered if the application receives pre-defined or timer triggering events.
 
 \renewcommand{\lstlistingname}{Example}
 
 \begin{lstlisting}[basicstyle=\ttfamily\footnotesize,language=SQL,caption=EPL of EsperTech query example,label=EPLqueries]
  select A as temp1, B as temp2 from 
    pattern [every temp1.temperature > 400 
    -> temp2.temperature > 400]
 \end{lstlisting}
 
In the above example (see Example~\ref{EPLqueries}) a ``Nuclear reactor'' needs to measure the temperature
of its systems, its temperature gauges take a reading of the core temperature every second and send the data 
to a central monitoring system. The EPL of EsperTech query throws a warning if we have 2 consecutive 
temperatures above a certain threshold (400). This is a situation where a quick reaction to emerging patterns 
is needed in a stream of data events. A quick reaction is also needed in fall detection, the pattern which 
describes this situation will be shown in the corresponding section.
 
Because the difficulties to simulate falls, IoT-TEG is used in order to get automatically the fall test events. 
IoT-TEG can be adapted or modified, if it is necessary, to generate any test events, even after the improvements 
in the fall-detection prototype.

\subsection{IoT test event generator}
\label{iotteg}

IoT-TEG~\cite{TesisGutierrez2017,Gutierrez2017} is a Java-based tool which takes an event 
type definition file and a desired output format (JSON, CSV, and XML, the most common across 
IoT platforms). IoT-TEG is made up of a \emph{validator} and an \emph{event generator} 
(Figure~\ref{fig:IoT-EGArquitecture}). The validator ensures the definition follows the rules set 
by IoT-TEG. The generator takes the definition and generates the indicated number of events according to it.

\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.65]{./img/IoT-EGArquitecture}
  \caption[IoT-TEG Architecture]{IoT-TEG Architecture~\cite{TesisGutierrez2017,Gutierrez2017}.}
  \label{fig:IoT-EGArquitecture}
\end{figure}

Previous studies suggested there were no differences in testing effectiveness between using events
generated by IoT-TEG, or events recorded from various case studies~\cite{TesisGutierrez2017,Gutierrez2017}. These
results confirm IoT-TEG can simulate many types of events occurring in industrial applications,
and solve the main challenges developers face when they test event-processing programs:
\begin{enumerate}
 \item Lack of data for testing,
 \item needing specific values for the events, and
 \item needing the source to generate the events.
\end{enumerate}

For the sake of clarity, Example~\ref{eventTypeDef} shows an event type
definition that could be used to test the queries of Example~\ref{EPLqueries}.

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize,language=XML,caption=Event type definition example,label=eventTypeDef]
<?xml version="1.0" encoding="UTF-8"?>
<event_type name="TemperatureEvent">
  <block name="feeds" repeat="150">
    <field name="created_at" quotes="true" 
     type="ComplexType">
     <attribute type="Date" format="yy-MM-dd">
     </attribute>
     <attribute type="String" format="T"></attribute>
     <attribute type="Time" format="hh:mm">
     </attribute>
    </field>
    <field name="entry_id" quotes="false" 
     type="Integer" min="0" max="10000">
    </field>
    <field name="temperature" quotes="false" 
     type="Float" min="0" max="500" precision="1">
    </field>
  </block>
</event_type>
\end{lstlisting}

The defined event type contains three properties: \texttt{created\_at},
\texttt{entry\_id} and \texttt{temperature}. These properties are defined as
fields in the event type definition. The \texttt{created\_at} field is complex
type and \texttt{entry\_id} and \texttt{temperature} are simple types. The
property that is evaluated in the Example~\ref{eventTypeDef} queries is
\texttt{temperature}.

\section{Prototype}
\label{sec:basicprototype}

\subsection{Architecture}
\label{sub:basicprototypearchitecture}

The system architecture is an important part to provide a precise and reliable fall-analysis. 
Additionally, the aspect of patient compliance should be taken into consideration, because the 
system should be developed not only from the developer point of view, but it should be accepted 
by the patients. An important requirement of the elderly is that the hardware design should 
facilitate the freedom of movement. Furthermore, the system should guarantee a reliable 
functionality and a redundancy to protect the wearable system against a total system failure. 
With reference to these aspects a BAN in form of a belt was developed which 
includes a five sensor nodes which is based on ZigBee/IEEE 802.15.4\footnote{\url{http://www.zigbee.org/}}.

\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.25]{./img/belt}
  \caption[Fall-detection belt]{Fall-detection belt~\cite{LaBlunda.2016,LaBlunda.2016b,LaBlunda.2016c}}
  \label{fig:belt}
\end{figure}

Four of the sensor nodes are acting as end-devices (S1-S4) and the other node as a coordinator. 
The end-devices have attached an accelerometer and gyroscope which acquire continuously sensor 
data and is sent wirelessly to the coordinator using the ZigBee protocol. The data is sent in the following format:
 \begin{center}
  \texttt{AccelMagnitude, Gyro-X, Gyro-Y, Gyro-Z}
 \end{center}
\begin{itemize}
  \item \textbf{AccelMagnitude} $\rightarrow$ This value represents the acceleration magnitude which is calculated 
  by the Equation (\ref{eq:acel}), see Section~\ref{subsec:analysis}. This value is a reference for impact detection. 
  The value's unit is m/s$^2$.
  \item \textbf{Gyro-X} $\rightarrow$ represents the angular acceleration in X direction. The value's unit is 
  degree per second (dps).
  \item \textbf{Gyro-Y} $\rightarrow$ represents the angular acceleration in Y direction. The value's unit is 
  degree per second (dps).
  \item \textbf{Gyro-Z} represents the angular acceleration in Z direction. The value's unit is degree per second (dps).
\end{itemize}
The coordinator receives the incoming data and it has the function to evaluate the patient's status.

The proposed positioning of sensors in the belt architecture was designed mainly for two reasons. The first reason 
reflects the requirement of a safety critical system to which the fall-detection prototype belongs. The reliability 
of the system must be ensured, in case one of the nodes fails. Using the architecture shown above (see Figure \ref{fig:belt}), 
a mirroring of the opposing sensors is achieved, which means that we get identical sensor values, only with different signs. 
In case a node fails, the opposite value can be taken as a reference to detect a possible fall. The other reason for 
applying this architecture effects the system's accuracy. Taking into consideration the following illustration 
(see Figure \ref{fig:axisreference}) facilitates the recognition of several fall-types.

\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.23]{./img/axis}
  \caption[Three axis reference draft]{Three axis reference draft \cite{LaBlunda.2016b,LuigiMasterThesis}}
  \label{fig:axisreference}
\end{figure}

The idea is, that with this special positioning more precise fall-characterization are achieved. Considering 
the event that a person does a left rotation and suffers a frontal impact to the ground (forward fall), 
the gyroscope information (single value axis X, Y and Z) could be used for the detection of rotation and the 
acceleration magnitude to detect the impact to the ground, see Equation (\ref{eq:acel}), see Section~\ref{subsec:analysis}.

To test the system's accuracy different fall-types were reproduced with several test persons. A 
test procedure based on Li et al.~\cite{Li2009} and Pannurat et al.~\cite{Pannurat2014} was developed which includes 
several motions and fall-types which are typical in nursing homes and hospitals.

Taking into account the architecture of the prototype and the rule to define a fall, see Equation (\ref{eq:acel}), 
the EPL of EsperTech pattern to define the fall situation is the one shown in the Example~\ref{FallPattern}.

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize,language=SQL,caption=Fall pattern,label=FallPattern]
  select a1.accelS1, a2.accelS1, a1.accelS2, 
   a2.accelS2 from 
   pattern [every(a1=BodyEvent(a1.accelS1 <= 9.81) -> 
   a2=BodyEvent(a2.accelS1 -a1.accelS1 >= 9.81 and 
   a1.PersonID = a2.PersonID) 
   where timer:within(1sec)) or every 
   (a1=BodyEvent(a1.accelS2 <= 9.81)
   -> a2=BodyEvent(a2.accelS2-a1.accelS2 >= 9.81
   and a1.PersonID = a2.PersonID) 
   where timer:within(1sec))];
 \end{lstlisting}

The illustrated EPL query is based on the physical principle depicted in 
Figure \ref{fig:grafica}. Important to know is that for EPL query two nodes 
were used (one frontal sensor node \& one lateral sensor node) to apply the 
fall-detection, but in future this query will be extended to four sensor nodes. 
The four node architecture (see Figure \ref{fig:belt}) is currently only used 
for redundancy purposes. With the \textit{select} statement the event properties 
are selected to create a pattern for fall-detection. In the given example the
following event properties are selected:

\begin{itemize}
 \item \texttt{a1.accelS1}: starting acceleration value of node 1.
 \item \texttt{a2.accelS1}: subsequent acceleration value of node 1.
 \item \texttt{a1.accelS2}: starting acceleration value of node 2.
 \item \texttt{a2.accelS2}: subsequent acceleration value of node 2.
\end{itemize}

Taking into consideration the selected event properties the query checks if the 
starting acceleration of sensor node 1 is $<=$ 9.81 m/s$^2$ which means the person 
is in a stationary position in which the earth's gravity of 1g (9,81 m/$s^2$) on 
the body. Additionally the subsequent acceleration of the first node checks if the 
subtraction of the subsequent acceleration and the first acceleration within a 
time window of 1 second is $>=$ 9.81 m/$s^2$ which means that the patient has 
suffered an impact to the ground. Using the \textit{OR} disjunction the second 
sensor node can be added and the statement is able to detect a fall in case one 
of the nodes matches the EPL query and the values of the acceleration correspond 
to the same person. 
 
\subsection{Fall simulation test events} 

The fall to generate the test events have been selected from~\cite{Li2009,Pannurat2014}. 
The fall consists on rolling in the bed and fall (RBF). In this study we have used a 
healthy subject, and we have recorded falls with all possible realism while also
trying to avoid risks. The person has been doing RBF type falls for a period of 2 minutes. The analysed 
data and videos can be found in ~\cite{}. In the following lines the steps to simulate 
the fall with the generated events are described, theses steps are very similar to the 
ones followed by~\cite{colladomachine,colladoTriaxal}:

\subsubsection*{1. Study of the values} Given that the sensor 1 is the one that suffers the
impact, its acceleration values are the first to be analysed. The Figure~\ref{fig:Sensor1Sombras} 
shows the acceleration data from sensor 1 while the person was falling. The goal is to study 
the acceleration behaviour during a fall in order to generate test events, so the acceleration 
values are normalised ($N(m/s^2)$). The normalised acceleration is shown in Y edge, and the 
time in milliseconds (ms) is in X edge.

While performing the data analysis, it has to be taken into account that the values suffer 
alterations because several factors: the person movement, the person bounces against something 
(floor, wall, etc), the collocation of the sensors to the original position after a fall, 
sensor pressure because an impact or the person is laying over it, etc.

 \begin{figure*}[!h]
  \includegraphics[scale=0.375]{Sensor1Sombras}
  \caption[Sensor 1 acceleration]{Sensor 1 acceleration.}
  \label{fig:Sensor1Sombras}
\end{figure*}

\subsubsection*{2. Fall identification and analysis} After the previous study, the peaks of the acceleration are identified. 
These peaks, or maximum values, are when the sensor suffers the impact. Because the mentioned noise, two ranges of the obtained 
values are extracted in order to analyse data properly. Please, see the highlighted parts in Figure~\ref{fig:Sensor1Sombras};
according to X edge $[210, 360]$ (Fall 1) and $[900, 1050]$ (Fall 2). The range of extracted values are a set of data that 
happen is less than a time window of 1 second, to meet the fact described in~\cite{Luder2009}. So as to compare both RBF falls
the acceleration values are normalised according to their impact value. The Table~\ref{tabla:RBF} 
shows the values to analyse where the impact value is highlighted with colour green.

\begin{table}[!h]
 \centering
 \begin{tabular}{*{5}{r}}
   \input{table-RBF}
 \end{tabular}
 \caption{RBF fall acceleration, fall (range) 1 and fall (range) 2}%
 \label{tabla:RBF}
\end{table}

The obtained data do not have a timestamp, so given that every 10 milliseconds the system sends the data, we have
divided the values according to this time. To compare the RBF falls the time in the Table~\ref{tabla:RBF} 
stars in 0 ms and then increase in 10 milliseconds ($ms$), that is what it is shown in 
the first column of the Table. The second column show the acceleration values ($m/s^2$) and in the third column
are deployed the normalised acceleration values ($N(m/s^2)$) according to the fall maximum value. In 
Figure~\ref{fig:Sensor1} a comparison of the normalised acceleration behaviour during the previous RBF falls is shown. 
This comparison show a similar behaviour of the acceleration during the RBF falls.
Moreover, the acceleration in these two RBF falls follow the rule that define a fall, see Equation (\ref{eq:caida}), 
see Section~\ref{subsec:analysis}.

\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.5]{img/Comparativa}
  \caption[Acceleration comparative]{Acceleration comparative.}
  \label{fig:Sensor1}
\end{figure}

The goal is to simulate this type of fall with events to test the IoT system, so we have to analyse the values of 
the acceleration before and after the impact. Taking into account that the maximum value of the acceleration is 
when the impact occurs ($\alpha_{max}$), the acceleration behaviour during a RBF fall consists on:
\begin{enumerate}
 \item from a value less than the half of $\alpha_{max}$, the acceleration value increases to obtain a value in the range:
  \begin{center}
  $[\alpha_{max}/2 - 0.5, \alpha_{max}/2 + 0.5]$
  \end{center}
 The person is rolling on the bed.
 \item when the acceleration obtains a value in the previous range, its value decrease until the minimum value $\alpha_{min}$.
 The person is falling, a free fall.
 \item the acceleration value goes from the minimum value $\alpha_{min}$ to the maximum value $\alpha_{max}$. The person
 suffers the impact.
 \item the acceleration value is established with values around the half of $\alpha_{max}$. The person is laying on the floor. 
\end{enumerate}

The same analysis process has been done to the rest of sensors, and the behaviour of the acceleration of all of them 
follows the same pattern.

Taking into account the architecture of the prototype and the previous rules to define a RBF fall, the EPL of EsperTech
pattern to the define a RBF fall is the one shown in the Example~\ref{}.

\textbf{*We should include an EPL query to detect this RBF fall*}

\subsubsection*{3. To define the fall event} Once the fall acceleration behaviour has been observed, the next step is to define the 
fall event in order to generate test events with IoT-TEG~\cite{TesisGutierrez2017,Gutierrez2017}. As it was explained in Section~\ref{iotteg}, the event type attributes have
to be defined using the \texttt{<field>} element. The fall event contains one attribute, the acceleration, which is float, 
\texttt{type=``Float''}, and its values are not quoted, \texttt{quotes=``false''}. A new parameter in IoT-TEG has been defined as a 
consequence of the previous falls study. Given that the acceleration values follow a specific behaviour, it is necessary to include 
the \texttt{custom\_behaviour} property in the \texttt{<field>} element to define the behaviour of any event attribute; 
in this study, the acceleration. In the \texttt{custom\_behaviour} property the path to the file that includes the behaviour of the 
event attribute has to be written. The Example~\ref{FallEvent} shows the complete fall event definition (FallEventType).

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize,language=XML,caption={Fall event type definition},label=FallEvent]
<?xml version="1.0" encoding="UTF-8"?>
<event name="FallEventType">
<block name="feeds" repeat="100">
 <field name="acceleration" 
 quotes="false" type="Float" 
 custom_behaviour="/Path/To/Rule/File"></field>
</block>
</event>
\end{lstlisting}

IoT-TEG includes a new functionality, which has been implemented to simulate the desired behaviour of an 
event attribute with a \texttt{custom\_behaviour} property in its event type definition. This functionality 
allows to generate values of the event attribute following a behaviour that the user has described in a file.
In order to explain how the user has to define the desired behaviour of an event attribute, we are going
to use the RBF fall behaviour rules (see Example~\ref{RBFFallRules}). In a XML file the number of simulations has to be
indicated, the events involved in a simulation will be calculated according to the total number of events
to generate and the desired simulations. For example, if the number of test events to generate is 100, 
number indicated in the event type definition file, \texttt{repeat="100"}, and the number of desired 
simulations is 5, \texttt{simulations="5"}, number indicated in the behaviour rules definition file, 
the number of events involved to simulate the behaviour is 20. In the RBF fall example, the user ask to 
generate 100 test events and 5 falls (simulations), so 20 events will be used to define a RBF fall.

Variables can be defined if they are needed in the behaviour rules. They can be defined in the file where
the behaviour rules are included using the \texttt{<variables>} tags. To define them a name and a value 
have to be given to the variables. The value can be defined as a fixed value with the \texttt{value} 
property, or using a range with the \texttt{min} and \texttt{max} properties. Moreover, in some variables
are involved in the value of another variables; this is indicated using the variable with an specific 
format \texttt{\$(variable)}, see Example~\ref{RBFFallRules}. In addition, arithmetic operations can be 
done in the definition of the variable values. Let us see how using them in the RBF fall example. To 
define the acceleration behaviour during a RBF fall three variables are defined: \texttt{Roll}, 
\texttt{Fall} and \texttt{Impact}. The \texttt{Impact} will be the maximum value $\alpha_{max}$, the 
\texttt{Fall} will be the minimum value $\alpha_{min}$ and the \texttt{Roll} variable is defined by a 
range where the acceleration value will be obtained according to the \texttt{Impact} value. In order to
obtain a low value, a range between 0 and the fifth part of \texttt{Roll} is assigned to the \texttt{Fall} 
variable.

Once the variables are defined, the \texttt{<rules>} tags are used to define the rules. A \texttt{weight}
must be assigned to each one to calculate the number of events to generate for each rule for each simulation.
Following the example and the assigned \texttt{weight} in Example~\ref{RBFFallRules}, if 20 events simulate 
a RBF fall $20 * 0,25 = 5$ events will be generated for the first rule, another 5 events for the second rule,
1 event for the third rule, and the remained events for the fourth rule. We have to assign zero to the weight
\texttt{weight="0"} to indicate how the remained events have to be generated.

To define the rules, \texttt{min}, \texttt{max} and \texttt{value} properties can be used as well as the arithmetic 
operations and the references to another variables. Moreover, the \texttt{sequence} property can be used to obtain
values lower or higher than the one generated previously. The \texttt{sequence} property values are \texttt{inc}, 
to increase the value, or \texttt{dec}, to decrease the value.

Thanks to the included properties and parameters in the IoT-TEG new functionality, the desired behaviour rules can
be defined. In the RBF fall rules, the involved event attribute is the acceleration, and its behaviour during the 
fall is defined by four rules; in the first rule the acceleration value increases to a value close or equal to \texttt{Roll},
in the second rule the acceleration value decreases to a value close or equal to \texttt{Fall}, in the third rule the 
acceleration value is equal to \texttt{Impact}, it obtains the highest value and in the fourth rule the acceleration value
is established in a range which is lower than \texttt{Roll}.

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize,language=XML,caption={Rules to define a RBF fall},label=RBFFallRules]
  <?xml version="1.0" encoding="UTF-8"?>
  <custom_conditions simulations="5">
  <variables>
   <variable name="Impact" min="40.0" max="156.96"/>
   <variable name="Roll" min="$(Impact)/2-0.5" 
                             max="$(Impact)/2+0.5"/>
   <variable name="Fall" min="0.0" max="$(Roll)/5"/>
  </variables>
  <rules>
   <rule weight="0.25" min="$(Roll)/4" max="$(Roll)" 
                                    sequence="inc"/>
   <rule weight="0.25" min="$(Roll)" max="$(Fall)" 
                                    sequence="dec"/>
   <rule weight="1" value="$(Impact)"/>
   <rule weight="0" min="$(Roll)/2-0.25" 
                              max="$(Roll)/2+0.25"/>
  </rules>
  </custom_conditions>
\end{lstlisting}

It is needed to highlight that to obtain these rules to define the behaviour of the acceleration several test
have been done. Once we obtained the desired results, test events were generated as they were necessary. The 
Figure~\ref{fig:IoTTEGRBFGeneratedEvents} shows the acceleration values of some of the generated RBF falls using
IoT-TEG and the new functionality.

\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.3]{img/IoTTEGRBFGeneratedEvents}
  \caption[IoT-TEG generated RBF falls]{IoT-TEG generated RBF falls.}
  \label{fig:IoTTEGRBFGeneratedEvents}
\end{figure}

The generated events which simulate RBF falls follow the pattern of the acceleration during a RBF fall.
So, these generated events can be used to test the fall detection system.

\section{Improved prototype}
\label{sec:improvedprototype}

\subsection{Architecture}
\label{sub:improvedprototypearchitecture}

Taking into consideration the architecture of the prototype described in the previous 
section significant improvements were done. The improved hardware architecture is also 
based on four sensor nodes (S1-S4), but with the following significant innovations:

\begin{itemize}
 \item New hardware platform which is based on Arduino Primo Core~\cite{Arduino2018}. 
 This micro-controller provides built-in sensors and a Bluetooth Low Energy (BLE) 
 interface for wireless data transmission. This leads to satisfy the patient compliance
 which includes the mobility of movement.
 \item A different power supply mode is used for the improved prototype. Instead of 
 using the Lithium Polymer (LIPO) batteries, the Arduino Primo Core is supplied by a 
 coin cell. This is an important aspect due to the fact, that exposing the LIPO-batteries 
 to permanent shocks will damage them and drastically shorten their lifespan. 
 Additionally with the usage of coin cells, we have reached a lifespan of 2 to 3 weeks 
 without exchanging the battery.
 \item The improved Prototype is using BLE for wireless data transmission. Using BLE 
 brings the advantage to build up a communication infrastructure with the smartphone 
 to automatically inform the emergency services without any additional hardware.
 \item The dataset which is sent by the sensor nodes (S1- S4) is composed as follows 
 and includes the values unit m/$s^2$:
 \begin{center}
  \texttt{SensorID, X-Acceleration, Y-Acceleration, Z-Acceleration}
 \end{center}
 Compared to the dataset format of the previous prototype the sensor identification 
 number was added and the significantly change is that only the single axis values of 
 the accelerometer are sent. Based on the individual axis values of the accelerometer, 
 the orientation of the person can also be determined. Assuming the person is in a standing 
 position, the x-axis corresponds to 1G ($\pm$ 9.81m/$s^2$) and the other two axes would be 
 approximately 0G. This indicates that the person is standing. As the person changes 
 position, the gravitational acceleration will occur on one of the other axis. For that 
 reason, in the improved prototype the single axis values were taken as orientation 
 reference. To detect the impact the single values were used to calculate the acceleration 
 magnitude based on Equation (\ref{eq:acel}), see Section~\ref{subsec:analysis}.
\end{itemize}

\subsection{Fall simulation test events}

The second fall to generate the test events consists on the impact of the person with 
a wall and falling on the knees and then on the chest: \textit{fall against wall} (FAW). 
In this study we have used two healthy subjects, and we have recorded falls with all 
possible realism while also trying to avoid risks. They have been doing fall test for a period 
of 2 minutes, the FAW fall type. The analysed data and videos can be found in ~\cite{}.

In this analysis the same steps that the ones described in Section~\ref{sec:basicprototype} 
have been done:

\subsubsection*{Study of the values} Given that the sensor 1 is the one that suffers the 
impact, its acceleration values are the first to be analysed. The acceleration values have 
been normalised ($N(m/s^2)$). After the normalisation the impacts of the falls, peaks, 
have to be detected; we have considered a peak when the normalised acceleration is 
greater than 0,7 ($N(m/s^2) > 0,7$). After applying the previous rule in all the fall data 
and taking into account the alterations because the mentioned factors, the impacts are detected.

\subsubsection*{Fall identification and analysis} Once the peaks are detected, a range of values, 
including the peaks, are selected in order to analyse data properly and to study the acceleration 
behaviour during FAW fall. The range of extracted values are a set of data that happen in less 
than a time window of 1 second, to meet the fall rule of~\cite{Luder2009} described in 
Equation (\ref{eq:caida}), see Section~\ref{subsec:analysis}. The Table~\ref{tabla:FAW} shows the 
acceleration value during one FAW fall of person 1 and person 2. 

\begin{table}[!h]
 \centering
 \begin{tabular}{*{5}{r}}
   \input{table-FAW}
 \end{tabular}
 \caption{FAW fall acceleration, person 1 and 2}%
 \label{tabla:FAW}
\end{table}

The first and fourth columns of the Table~\ref{tabla:FAW} represent the seconds and milliseconds 
($s.ms$) when the acceleration was measured. The second and fifth columns show the acceleration 
values ($m/s^2$) and in the third and sixth columns are deployed the normalised acceleration values 
($N(m/s^2)$) according to the fall maximum value. In Figure~\ref{fig:FAWcomparison} a comparison 
of the normalised acceleration behaviour during the previous FAW falls of person 1 and person 2 is 
shown. These comparisons show a similar behaviour of the acceleration during the FAW fall.

\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.23]{img/TwoFallsComparative.png}
  \caption[Acceleration during FAW fall]{Acceleration comparison during FAW fall.}
  \label{fig:FAWcomparison}
\end{figure}

For the FAW, we have decided to define the acceleration behaviour with normalised values; so the 
normalised acceleration behaviour during the FAW consists on:
\begin{enumerate}
 \item the variation of its values while the person is walking. We have divided this rule in two rules:
 \begin{enumerate}
  \item The normalised acceleration values go increasing in a range [0, 0.35].
  \item The normalised acceleration values go decreasing in a range [0, 0.35].
 \end{enumerate}
 \item as a consequence of the impact of the person against a wall, the acceleration normalised value 
 has to be greater than 0.7.
 \item the normalised acceleration values decreases to a range [0, 0.35]. The values of the acceleration are 
 in the mentioned range depending on the size of the person; the larger person results in a longer range 
 and if the person retains a position prior to a fall thanks to the wall. Moreover, a subtle peak could 
 appear as a consequence of a rebound.
 \item a second impact happens when the person hit the ground, the acceleration normalised values has to 
 be greater than 0.7.
 \item finally, the person is laying on the ground and the normalised acceleration value decreases. The 
 values of the acceleration are between [0.10, 0.35] and no subtle peaks appear. 
\end{enumerate}

The same analysis process has been done to the rest of sensors, and the behaviour of the acceleration of all of 
them follows the same pattern.

Taking into account the architecture of the prototype and the previous rules to define a FAW fall, the EPL of EsperTech
pattern to the define a FAW fall is the one shown in the Example~\ref{}.

\textbf{* Like with the RBF fall, we should include a new fall definition of FAW type of fall.*}

\subsubsection*{To define the fall event} Once the fall acceleration behaviour has been observed, the next step is to define the 
fall event in order to generate test events with IoT-TEG~\cite{TesisGutierrez2017,Gutierrez2017}. Given that the involved event 
attribute in this fall is the acceleration, the Example~\ref{FallEvent} in Section~\ref{sec:basicprototype} can be used to define 
the fall event (FallEventType). The rules to define the behaviour of the acceleration in this type of fall is shown in 
Example~\ref{FAWFallRules}.

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize,language=XML,caption={Rules to define a FAW fall},label=FAWFallRules]
  <?xml version="1.0" encoding="UTF-8"?>
  <custom_conditions simulations="5">
  <variables>
   <variable name="Base" value="9.81"/>
   <variable name="ImpactWall" 
         min="$(Base)+$(Base)*0.7" max="$(Base)*3"/>
   <variable name="Impact" min="$(Base)+$(Base)*0.7" 
                                   max="$(Base)*3"/>
  </variables>
  <rules>
   <rule weight="0.25" min="0" 
         max="$(ImpactWall)*0.35" sequence="inc"/>
   <rule weight="0.25" min="0" 
         max="$(ImpactWall)*0.35" sequence="dec"/>
   <rule weight="1" value="$(ImpactWall)"/>
   <rule weight="0.25" min="0" 
                        max="$(Impact)*0.35"/>
   <rule weight="1" value="$(Impact)"/>
   <rule weight="0" min="$(Base)+$(Base)*0.10" 
                        max="$(Impact)*0.35"/>
  </rules>
  </custom_conditions>
\end{lstlisting}

To define the acceleration behaviour during a FAW fall three variables are defined: \texttt{Base}, 
\texttt{ImpactWall} and \texttt{Impact}. Given that the acceleration behaviour during a FAW fall has
being done according to the normalised values, the variables and rules have been defined according to 
that analysis. The acceleration value in a stationary position is variable depending on the person, so 
we have considered the established value, $1g\approx9.81m/s^{2}$. That is the fixed value of the 
\texttt{Base} variable. To determine the values of the impacts, we have taken into account that the 
normalised value have to be $> 0,7$. So, to ensure that the impacts, \texttt{ImpactWall} and 
\texttt{Impact}, have a value meeting the mentioned condition the minimum value of the impact is the 
sum of the \texttt{Base} and \texttt{Base} multiply by \texttt{Base}$*0,7$; and the maximum value of the
impacts is $3g\approx9,81*3=$\texttt{Base}$*3$.

Once the variables are defined, the rules have to be determined. The first step is to indicate the 
\texttt{weight} for each rule in order to calculate the number of events to generate for each rule for 
each simulation. Following the simulation values the number of events to generate for each rule, according 
to the assigned weights, is: $20 * 0,25 = 5$ events will be generated for the first rule, another 5 events 
for the second rule, 1 event for the third rule, 5 events for the fourth rule, 1 event for the fifth
rule and the remained events, three events, for the sixth rule. 

Thanks to the included properties and parameters in the IoT-TEG new functionality, the desired behaviour rules that
follow the normalised acceleration values can be defined. Given that we have considered to define the FAW fall behaviour
rules according to the normalised values, the values to generate depend on the maximum value. Due to there are two 
values that can be the highest one, \texttt{ImpactWall} or \texttt{Impact}, the rules that depend on the maximum 
value contains the reference to the value, \texttt{ImpactWall} or \texttt{Impact}, according to the proximity
of the rule. For instance, the first and second FAW fall rules contain a reference to \texttt{ImpactWall}, the impact 
in the wall (third rule), which happens after the person is walking, something described in the first and the second rules.
The fourth and sixth rules contain a reference to \texttt{Impact}, the impact on the ground (fifth rule), which happen
after the person is falling and the person is laying on the floor, fourth and sixth rules.

It is needed to highlight that to obtain these rules to define the behaviour of the normalised acceleration several test
have been done. Once we obtained the desired results, test events were generated as they were necessary. The 
Figure~\ref{fig:IoTTEGFAWGeneratedEvents} shows the acceleration values of some of the generated FAW falls using
IoT-TEG and the new functionality.

\begin{figure}[!h]
  \centering
  \includegraphics[scale=0.22]{img/IoTTEGFAWGeneratedEvents}
  \caption[IoT-TEG generated FAW falls]{IoT-TEG generated FAW falls.}
  \label{fig:IoTTEGFAWGeneratedEvents}
\end{figure}

The generated events which simulate FAW falls follow the pattern of the acceleration during a FAW fall.
So, these generated events can be used to test the fall detection system.

The improvements in the prototype are notorious. They affect not only in the way of obtaining the data, but 
also in the format and their values. The impact values from one analysis to the other are quite different, 
this is because several reasons that are described in Section~\ref{sub:detectedproblems}. The difference
of values was not a problem for IoT-TEG to define the behaviour rules and to generate the test events. That
means that the introduced functionality can be adaptable to the analysed behaviour. Moreover, it is needed 
to highlight that the application of the new functionality covers any event attribute which follows a behaviour;
so IoT-TEG is not limited.

\subsection{Detected problems}
\label{sub:detectedproblems}

After testing the used fall detection prototype, some problems were 
found. Moreover, some considerations will be applied in future tests.

First of all, we are going to explain the problems related to the prototype; problems related to its hardware and
software. Talking about the software, the synchronisation in the prototype is an issue; we have founded the following problems:

\begin{itemize}
 \item In one hand, the falls from the beginning always should be discarded because the sensors are 
 sending a lot of data. The Table~\ref{tabla:Synchro} will be used to explain the problem. Let us say 
 that in ``fall 1'', there are more than 30 values that define the fall, and later in ``fall 3'', there are 
 12 values that define the fall. So, in order to analyse the falls and compare the acceleration behaviour, it is 
 difficult to work with that information. A comparison of two FAW falls with the synchronisation problem is shown
 in Figure~\ref{fig:synchronisation1}; the sensor 1 acceleration values for the first FAW fall are coloured in blue and the
 sensor 1 acceleration values for the second FAW fall are coloured in red. The first fall is one fall from the beginning
 of the simulation, and the second one is from the middle of the simulation.
 
 \begin{table}[!h]
 \centering
 \begin{tabular}{*{5}{r}}
   \input{table-Synchro}
 \end{tabular}
 \caption{Synchronisation problem, fall 1 and fall 2}%
 \label{tabla:Synchro}
 \end{table}
 
 \begin{figure}[!h]
  \centering
  \includegraphics[scale=0.21]{img/synchronisation1.png}
  \caption[Comparison acceleration during two FAW falls]{Synchronisation problem; comparison of acceleration values during two FAW falls.}
  \label{fig:synchronisation1}
 \end{figure}
 
 The acceleration values show that in less than 250 milliseconds there are more than 30 values from ``fall 1'', and
 in more than 350 milliseconds there are 12 values from ``fall 2''. There is a lack of synchronisation not only in
 the amount of data, but also in the time.
 
 \item On the other hand, some sensors transmit more data than the others; no matter the fall, the sensors are not 
 sending the same amount of data, even sometimes there is no data. The four sensors were working while the FAW fall
 simulation, but the obtained acceleration values were from three of them, one of the sensor does not transmit data 
 in one moment of the simulation, see Figure~\ref{fig:synchronisation2}.
 
 \begin{figure}[!h]
  \centering
  \includegraphics[scale=0.23]{img/synchronisation2.png}
  \caption[Comparison acceleration during two FAW falls]{Synchronisation problem; acceleration values from the four sensors during a FAW fall.}
  \label{fig:synchronisation2}
 \end{figure}
\end{itemize}

If we focus our attention to the hardware, the duration of the battery is also something to improve. Nowadays the 
duration of the battery is around 2 or 3 weeks, it depends on its use. If we want to use this IoT system with patients, 
specially with elderly people, or people that need special treatment, we have to increase the duration of the battery 
in order to change it as little as possible.

The analysis has revealed that while we were studying the acceleration data test, some of its values could be misinterpreted.
This is because the person that is falling for the simulation, stands up very fast. Given that we have been cautious
in our analysis and we have been checking not only the values but also the videos and matching them, we have detected
this issue. So, in our future tests, the person that is falling should wait at least 2 seconds laying on the floor 
after the fall for a better fall simulation. In a real situation, if a person falls and stands up means that the person
is conscious and is able to move and call to the emergency services, if it is necessary. On the contrary, if the person
falls and does not stand up this means that maybe the person is unconscious or is not able to move and call to the emergency
services. Therefore, waiting at least 2 seconds between falls in our test scenarios, will help not only to understand 
better the behaviour of the acceleration but also to do a better fall simulation.

Comparing the measured values of the fall-events (forward fall, fall against wall and rolling out of bed) of the two 
prototypes, it can be determined that the measured impact values of the first prototype are considerably higher than 
those of the improved solution. This difference is caused by multiple reasons. The main reason is the different 
experimental set-up of the first prototype and the improved solution. The hardware design of the first prototype is 
bulky compared to the improved one. Due to the bulky construction the sensor nodes are more exposed to vibrations and 
shocks, which results in higher impact values. Additionally the sensor nodes shifted during the fall. The result was 
that the test person repositioned the sensor nodes which leads to influence the impact value (acceleration magnitude). 
Taking this problem into consideration this problem was solved by introducing a smaller micro-controller platform 
which was introduced in  section \ref{sec:improvedprototype}. Despite the design differences in the two prototypes, 
we are able to detect falls.

\section{Conclusions}
\label{sec:conclusions}

The generated events using IoT-TEG~\cite{TesisGutierrez2017,Gutierrez2017} follow the behaviour of the analysed falls: 
RBF and FAW. The implemented functionality 
allows to generate events by defining rules which describe a desired behaviour. We can assign behaviour rules as many 
event attributes as the event type contains, and the values of each event attribute will follow the assigned behaviour.
The introduced functionality of IoT-TEG is able to adapt to the behaviour of the analysed event attribute, because
it was developed as tool to generate test events for any system which manages events and wants be tested.

According to the falls, we have detected the necessity to define the EPL query for each fall in the literature; this will
help to identify a fall from a no-fall. Moreover, it will be interesting to add different type of sensors such as air
pressure, and medical data such as ECG, in order to identify and define the falls.

\section{Future Work}

The main goal of this study is to improve IoT-TEG~\cite{TesisGutierrez2017,Gutierrez2017} tool in order to generate faithful 
test events which simulate the 
relevant situations that want to be filtered and, sometimes, are very difficult to imitate: adverse environment conditions, 
rise or fall in blood pressure, heart attack, falls... IoT-TEG is an ongoing tool, so more functionalities will be added
to cover the test necessities. In order to improve IoT-TEG, more real events will be analysed which let us know 
the real situations and behaviour of the events.

The introduced IoT-TEG functionality will be improved with a new property. This property will allow to generate values 
for event attributes which follow behaviour rules but depends from another event attribute value. IoT-TEG has the option
to generate dependent values thanks to the \texttt{dependece} property. This property generates the event attribute value 
according to a fixed value; so we will extend the tool with the option to define a dependence rule between event attributes. 

To generate test events, reliable data transmission of all four sensor nodes (S1-S4) must be guaranteed. As described in 
the Section~\ref{sub:detectedproblems} the synchronisation problem can lead to data loss during data transmission and 
thus influence the analysis of falls (see Table \ref{tabla:Synchro}). For this reason, the use of a real-time system 
based microcontroller platform is planned, which facilitates the synchronisation of the sensor nodes using a 
priority-controlled task scheduler. In addition, the battery lifespan should be extended and the hardware design of the 
prototype should be small as possible so that patients are not restricted in their movements.

Fall detection systems are safety critical. Therefore, new developments will include hazards analysis methods
to satisfy safety standars, i.e. IEC61508, IEC60601, etc.

\section*{Acknowledgment}

Paper partially funded by The Ministry of Economy and Competitiveness (Spain) and the FEDER Fund, under the National Program for 
Research, Development and Innovation, Societal Challenges Oriented, Project DArDOS TIN2015-65845-C3-3-R, and the
Programa de Fomento e Impulso de la actividad Investigadora of the University of Cdiz.

\bibliographystyle{IEEEtran}
% argument is your BibTeX string definitions and bibliography database(s)
\bibliography{references}

% that's all folks
\end{document}


